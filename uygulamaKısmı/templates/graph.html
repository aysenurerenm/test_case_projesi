{% extends 'base.html' %}
{% block content %}
<div class="p-6 max-w-5xl mx-auto">
    <h1 class="text-2xl font-bold mb-4 text-indigo-800">Kontrol Akış Grafı</h1>

    <form method="post" class="mb-8">
        {% csrf_token %}
        <textarea name="code" rows="8"
            class="w-full p-4 border rounded-lg shadow-sm"
            placeholder="Python kodu...">{{ code|default:"" }}</textarea>
        <button type="submit"
            class="mt-2 bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700">
            Graf Oluştur
        </button>
    </form>

{% if cfg %}
<div class="border bg-white rounded-xl shadow-lg">
    <div id="graph" style="width:100%; height:600px;"></div>
</div>

<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
const graphData = JSON.parse(`{{ cfg|escapejs }}`);

const width = document.getElementById("graph").clientWidth;
const height = 600;
const NODE_RADIUS = 50;

const svg = d3.select("#graph").append("svg")
    .attr("width", width)
    .attr("height", height);

const g = svg.append("g");

svg.call(d3.zoom().on("zoom", e => g.attr("transform", e.transform)));

/* OK */
svg.append("defs").append("marker")
    .attr("id", "arrow")
    .attr("viewBox", "0 -5 10 10")
    .attr("refX", NODE_RADIUS + 8)
    .attr("refY", 0)
    .attr("orient", "auto")
    .attr("markerWidth", 6)
    .attr("markerHeight", 6)
    .append("path")
    .attr("d", "M0,-5L10,0L0,5")
    .attr("fill", "#6366f1");

/* FORCE */
const simulation = d3.forceSimulation(graphData.nodes)
    .force("link", d3.forceLink(graphData.edges)
        .id(d => d.id)
        .distance(180)
        .strength(0.9))
    .force("charge", d3.forceManyBody().strength(-1500))
    .force("center", d3.forceCenter(width/2, height/2))
    .force("collide", d3.forceCollide().radius(70));

/* EDGES */
const link = g.append("g")
    .selectAll("path")
    .data(graphData.edges)
    .enter().append("path")
    .attr("fill","none")
    .attr("stroke","#94a3b8")
    .attr("stroke-width",2)
    .attr("marker-end","url(#arrow)");

/* EDGE LABEL */
const linkLabel = g.append("g")
    .selectAll("text")
    .data(graphData.edges)
    .enter().append("text")
    .attr("font-size","10px")
    .attr("fill","#334155")
    .attr("text-anchor","middle")
    .text(d => d.label || "");

/* NODES */
const node = g.append("g")
    .selectAll("g")
    .data(graphData.nodes)
    .enter().append("g")
    .call(d3.drag()
        .on("start",(e,d)=>{
            if(!e.active) simulation.alphaTarget(0.3).restart();
            d.fx=d.x; d.fy=d.y;
        })
        .on("drag",(e,d)=>{ d.fx=e.x; d.fy=e.y; })
        .on("end",(e,d)=>{
            if(!e.active) simulation.alphaTarget(0);
            d.fx=null; d.fy=null;
        })
    );

node.append("circle")
    .attr("r",NODE_RADIUS)
    .attr("fill","#4f46e5")
    .attr("stroke","#fff")
    .attr("stroke-width",2);

node.append("text")
    .text(d=>d.label)
    .attr("text-anchor","middle")
    .attr("dy",4)
    .attr("fill","#fff")
    .attr("font-size","10px")
    .attr("font-weight","600");

/* TICK */
simulation.on("tick",()=>{

    link.attr("d", d => {
        const sx=d.source.x, sy=d.source.y;
        const tx=d.target.x, ty=d.target.y;
        const dx=tx-sx, dy=ty-sy;

        let curve=1.2, sweep=1;
        if(d.label==="if"){ curve=0; sweep=1; }
        else if(d.label==="else"){ curve=1; sweep=1; }
        else if(d.label?.startsWith("elif")){ curve=2; sweep=1; }

        const dr=Math.sqrt(dx*dx+dy*dy)*curve;
        return `M${sx},${sy} A${dr},${dr} 0 0,${sweep} ${tx},${ty}`;
    });

    linkLabel
        .attr("x", d => (d.source.x + d.target.x)/2)
        .attr("y", d => {
            let off=0;
            if(d.label==="if") off=-12;
            if(d.label==="else") off=12;
            if(d.label?.startsWith("elif")) off=-2;
            return (d.source.y + d.target.y)/2 + off;
        });

    node.attr("transform", d => `translate(${d.x},${d.y})`);
});
</script>
{% endif %}
</div>
{% endblock %}
